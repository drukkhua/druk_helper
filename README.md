# 🤖 Интеллектуальный Telegram Bot для Типографии

Современный AI-powered бот-помощник для автоматизации клиентского сервиса полиграфической типографии с персонализированным общением и расширенной аналитикой.

## ✨ Основные возможности

### 🎭 Двойная AI-система
- **🤖 Стандартный AI-помощник** - классические ответы на основе базы знаний
- **🎭 Персонализированный AI "Олена"** - живое общение с памятью контекста и адаптацией под пользователя
- **🔄 Переключение между режимами** прямо в главном меню

### 📋 Интерактивное меню
- **Категории товаров**: визитки, футболки, листовки, наклейки, блокноты
- **Динамические кнопки** с названиями из Google Sheets
- **Двуязычная поддержка** (украинский/русский) с переключением
- **Поиск по базе знаний** с расширенными символами (`*+/%²³`)

### 🧠 Расширенная AI-система
- **Векторная база знаний ChromaDB** с семантическим поиском
- **RAG (Retrieval-Augmented Generation)** для контекстных ответов
- **Память разговоров** с персонализацией ответов
- **Upselling engine** для премиального ценообразования
- **Автокоррекция и обучение** от администраторов

### 📊 Продвинутая аналитика
- **Real-time мониторинг** AI-ответов с метриками уверенности
- **Аналитика пользователей** и популярных запросов
- **Дашборд производительности** с детализацией по времени
- **Автоматические предложения** по улучшению базы знаний
- **Экспорт статистики** в различных форматах

### 🔗 Интеграции и синхронизация
- **Google Sheets API** для управления контентом
- **Умная синхронизация** с автоматическим обновлением
- **Многоформатный экспорт** (JSON, CSV, Excel, Markdown, YAML)
- **Backup и восстановление** базы знаний

## 🏗 Архитектура проекта

```
Bot-answers/
├── main.py                     # 🚀 Точка входа приложения
├── config.py                   # ⚙️ Централизованная конфигурация
├── bot_lifecycle.py            # 🔄 Управление жизненным циклом
├── requirements.txt            # 📦 Python зависимости
├── pyproject.toml             # 🛠 Poetry конфигурация
├── data/                       # 💾 Данные приложения
│   ├── templates/              #   📋 CSV шаблоны ответов
│   ├── vectorstore/           #   🧠 ChromaDB векторная база
│   ├── conversations/         #   💬 Логи разговоров
│   ├── analytics.db           #   📊 SQLite база аналитики
│   └── unified_system.db      #   🗃 Основная БД системы
├── src/                        # 💻 Основной код
│   ├── ai/                    #   🤖 AI сервисы и RAG
│   │   ├── enhanced_ai_service.py     # 🎭 Персонализированный AI
│   │   ├── enhanced_rag_service.py    # 🧠 Улучшенный RAG
│   │   ├── conversation_memory.py     # 💭 Память разговоров
│   │   ├── upselling_engine.py        # 💰 Премиум предложения
│   │   └── smart_knowledge_updater.py # 📚 Умное обновление знаний
│   ├── bot/                   #   📱 Telegram bot
│   │   ├── handlers/          #     🎯 Обработчики событий
│   │   ├── keyboards.py       #     ⌨️ Динамические клавиатуры
│   │   └── models.py          #     📋 Модели данных
│   ├── core/                  #   🎯 Бизнес-логика
│   │   ├── template_manager.py #     📋 Управление шаблонами
│   │   ├── validation.py       #     🔒 Валидация входных данных
│   │   └── business_hours.py   #     🕒 Рабочее время
│   ├── analytics/             #   📈 Система аналитики
│   │   ├── analytics_service.py #    📊 Сервис аналитики
│   │   ├── dashboard.py        #     📋 Дашборд отчетов
│   │   └── models.py           #     🗃 Модели данных
│   ├── integrations/          #   🔗 Внешние интеграции
│   │   └── knowledge_sync.py   #     🔄 Синхронизация знаний
│   ├── admin/                 #   👑 Админские функции
│   │   ├── knowledge_base_manager.py # 📚 Управление БЗ
│   │   ├── quick_corrections.py      # ✏️ Быстрые исправления
│   │   └── knowledge_sync_manager.py # 🔄 Менеджер синхронизации
│   ├── managers/              #   🎛 Системные менеджеры
│   └── utils/                 #   🛠 Утилиты и хелперы
└── tests/                      # 🧪 Тестирование
    ├── integration/            #   🔗 Интеграционные тесты
    └── unit/                   #   🔬 Юнит тесты
```

## 🛠 Технологический стек

### Backend & AI
- **Python 3.11+** - основной язык разработки
- **aiogram 3.x** - современный Telegram Bot API
- **OpenAI API** - GPT модели для AI-ответов
- **ChromaDB** - векторная база данных для семантического поиска
- **SQLite** - локальная аналитическая база данных

### Интеграции
- **Google Sheets API** - управление контентом через таблицы
- **Pandas** - обработка и анализ данных
- **asyncio** - асинхронная обработка запросов

### Мониторинг & Analytics
- **Real-time метрики** - производительность AI в реальном времени
- **Структурированное логирование** - детальные логи для отладки
- **Автоматические отчеты** - периодическая аналитика использования

## ⚡ Быстрый старт

### Предварительные требования

- Python 3.11+
- Telegram Bot Token ([создать бота](https://t.me/BotFather))
- OpenAI API Key ([получить ключ](https://platform.openai.com/api-keys))
- Google Sheets API credentials (опционально)

### Установка

1. **Клонирование репозитория:**
```bash
git clone <repository-url>
cd Bot-answers
```

2. **Создание виртуального окружения:**
```bash
python -m venv venv
source venv/bin/activate  # Linux/macOS
# venv\Scripts\activate   # Windows
```

3. **Установка зависимостей:**
```bash
pip install -r requirements.txt
```

4. **Настройка переменных окружения:**

Создайте файл `.env`:
```env
# Обязательные настройки
TELEGRAM_BOT_TOKEN=your_bot_token_here
OPENAI_API_KEY=your_openai_api_key_here
ADMIN_USER_IDS=123456789,987654321

# AI настройки
AI_ENABLED=true
AI_MODEL=gpt-3.5-turbo
AI_TEMPERATURE=0.7
AI_MAX_TOKENS=1000

# База знаний
KNOWLEDGE_BASE_ENABLED=true
VECTOR_STORE_PATH=./data/vectorstore

# Google Sheets (опционально)
GOOGLE_SHEETS_ENABLED=false
GOOGLE_SHEETS_CREDENTIALS_PATH=path/to/credentials.json
GOOGLE_SHEET_ID=your_sheet_id
```

5. **Запуск бота:**
```bash
python main.py
```

## 🎯 Функциональность

### 👤 Пользовательские возможности

#### Основное меню:
- 📇 **Визитки** - информация о визитках
- 👕 **Футболки** - каталог футболок и печати
- 📄 **Листовки** - листовки и флаеры
- 🔖 **Наклейки** - стикеры и наклейки
- 📋 **Блокноты** - блокноты и тетради
- 🔍 **Поиск** - поиск по базе знаний
- 🤖/🎭 **AI-переключатель** - выбор между стандартным и персонализированным AI
- 🇺🇦/🇷🇺 **Смена языка** - украинский/русский

#### AI-возможности:
- **Умные ответы** на естественном языке
- **Память контекста** разговора
- **Персонализация** под предпочтения пользователя
- **Технические характеристики** с поддержкой символов `*+/%²³`
- **Автоматические предложения** дополнительных услуг

### 👑 Администраторские команды

#### Основные команды:
- `/stats` - общая статистика использования
- `/reload` - полная перезагрузка системы и синхронизация
- `/health` - проверка здоровья всех компонентов
- `/analytics` - детальная аналитика AI за период
- `/sync` - умная синхронизация с проверкой изменений
- `/suggestions` - предложения по улучшению системы

#### Управление базой знаний:
- `/browse_kb` - просмотр содержимого базы знаний
- `/search_kb [запрос]` - поиск в базе знаний
- `/export_kb [формат]` - экспорт БЗ (json/csv/backup)

#### Расширенные команды:
- `/enhanced` - переход в режим персонализированного AI
- `/compare` - сравнение ответов обычного и персонализированного AI
- `/enhanced_stats` - статистика персонализации пользователя

### 🧠 AI и RAG система

#### Векторная база знаний:
- **ChromaDB** для семантического поиска
- **Автоматическая индексация** новых данных
- **Многоязычная поддержка** (украинский/русский)
- **Метаданные** для фильтрации и категоризации

#### Персонализированный AI "Олена":
- **Контекстная память** разговоров
- **Адаптация стиля** общения под пользователя
- **Эмоциональная окраска** ответов
- **Уточняющие вопросы** для лучшего понимания

#### RAG (Retrieval-Augmented Generation):
- **Семантический поиск** релевантной информации
- **Контекстное дополнение** ответов
- **Оценка уверенности** в ответах
- **Fallback механизмы** при низкой уверенности

## 📊 Аналитика и мониторинг

### Real-time метрики:
- **Уверенность AI** в ответах (0-100%)
- **Время ответа** AI-моделей в миллисекундах
- **Источники данных** для каждого ответа
- **Популярные запросы** пользователей

### Аналитические отчеты:
- **Статистика использования** шаблонов по категориям
- **Эффективность AI** с трендами по времени
- **Пробелы в знаниях** с предложениями дополнений
- **Поведение пользователей** и предпочтения

### Автоматизация:
- **Умные предложения** по улучшению базы знаний
- **Автоматическое обнаружение** популярных запросов без ответов
- **Периодические отчеты** для администраторов

## 🔄 Интеграции и синхронизация

### Google Sheets интеграция:
```python
# Структура таблицы
columns = [
    'category',      # Категория товара
    'group',         # Подкатегория/группа
    'button_text',   # Текст кнопки в меню
    'keywords',      # Ключевые слова для поиска
    'answer_ukr',    # Ответ на украинском
    'answer_rus',    # Ответ на русском
    'sort_order',    # Порядок сортировки
    'upsell_trigger', # Триггеры для upselling
    'price_range',   # Ценовой диапазон
    'priority'       # Приоритет показа
]
```

### Умная синхронизация:
- **Автоматическое обнаружение** изменений в Google Sheets
- **Инкрементальные обновления** только измененных данных
- **Валидация данных** перед импортом
- **Rollback механизм** при ошибках синхронизации

### Экспорт данных:
- **JSON** - для интеграций и бэкапов
- **CSV** - для Google Sheets и Excel
- **Markdown** - для документации
- **YAML** - для конфигураций

## 🔒 Безопасность и валидация

### Валидация входных данных:
```python
# Разрешенные символы для поиска
ALLOWED_SEARCH_CHARS = r"^[a-zA-Zа-яА-ЯёЁії\s\d\-_.,!?()\*\+/%²³]+$"

# Защита от инъекций
SUSPICIOUS_PATTERNS = [
    r"<script[^>]*>.*?</script>",  # XSS
    r"union\s+select",            # SQL injection
    r"javascript:",               # JavaScript протокол
    # ... другие паттерны
]
```

### Безопасность:
- **HTML экранирование** всех пользовательских данных
- **SQL injection защита** с параметризованными запросами
- **XSS предотвращение** в веб-интерфейсах
- **Rate limiting** для предотвращения спама
- **Логирование подозрительной активности**

## 🚀 Развертывание

### Production настройки:

1. **Системные требования:**
   - Ubuntu 20.04+ или аналогичная Linux система
   - Python 3.11+
   - 2GB RAM (минимум), 4GB RAM (рекомендуется)
   - 10GB свободного места

2. **Переменные окружения для production:**
```env
# Production настройки
ENVIRONMENT=production
LOG_LEVEL=INFO
AI_TEMPERATURE=0.5
AI_MAX_TOKENS=800

# Безопасность
ALLOWED_USERS_ONLY=false
RATE_LIMIT_ENABLED=true
```

3. **Systemd сервис:**
```ini
[Unit]
Description=Telegram Bot для типографии
After=network.target

[Service]
Type=simple
User=botuser
WorkingDirectory=/opt/telegram-bot
Environment=PYTHONPATH=/opt/telegram-bot
ExecStart=/opt/telegram-bot/venv/bin/python main.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

### Docker развертывание:

```dockerfile
FROM python:3.11-slim

WORKDIR /app
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .
CMD ["python", "main.py"]
```

```bash
# Сборка и запуск
docker build -t telegram-bot .
docker run -d --name bot --env-file .env --restart unless-stopped telegram-bot
```

## 📈 Мониторинг и отладка

### Логирование:
```python
# Уровни логирования
logging.DEBUG    # Детальная отладочная информация
logging.INFO     # Общая информация о работе
logging.WARNING  # Предупреждения о потенциальных проблемах
logging.ERROR    # Ошибки, не приводящие к остановке
logging.CRITICAL # Критические ошибки
```

### Метрики для мониторинга:
- **Время ответа AI** (целевое: <2000ms)
- **Успешность ответов** (целевое: >90%)
- **Использование памяти** (мониторинг векторной БД)
- **Ошибки синхронизации** с внешними сервисами

### Health checks:
```bash
# Проверка здоровья системы
curl -X GET "http://localhost:8000/health"

# Ответ при здоровой системе
{
  "status": "healthy",
  "ai_service": "operational",
  "vector_db": "connected",
  "google_sheets": "synced",
  "uptime": "2d 14h 32m"
}
```

## 🤝 Разработка и вклад в проект

### Структура разработки:

1. **Feature branches** для новых возможностей
2. **Code review** обязателен для всех изменений
3. **Автоматические тесты** при каждом коммите
4. **Семантическое версионирование** (SemVer)

### Тестирование:
```bash
# Запуск всех тестов
pytest

# Тесты с покрытием
pytest --cov=src

# Интеграционные тесты
pytest tests/integration/

# Линтинг и форматирование
ruff check src/
black src/
```

### Добавление новых функций:

1. Создайте branch от `main`
2. Реализуйте функцию с тестами
3. Обновите документацию
4. Создайте Pull Request
5. Пройдите code review

## 📊 Метрики и KPI

### Ключевые показатели:
- **Скорость ответа AI**: < 2 секунд (95-й перцентиль)
- **Точность ответов**: > 90% (по отзывам администраторов)
- **Покрытие базы знаний**: > 95% популярных запросов
- **Время работы системы**: > 99.5% uptime

### Бизнес-метрики:
- **Конверсия в продажи** через AI-рекомендации
- **Снижение нагрузки** на менеджеров (целевое: 60%)
- **Удовлетворенность клиентов** автоматизированными ответами
- **ROI автоматизации** клиентского сервиса

## 📄 Лицензия и поддержка

### Лицензия
Проект распространяется под лицензией MIT. Подробности в файле [LICENSE](LICENSE).

### Поддержка и помощь:
- 🐛 **Баги и ошибки**: [GitHub Issues](https://github.com/your-repo/issues)
- 💡 **Предложения**: [GitHub Discussions](https://github.com/your-repo/discussions)
- 📖 **Документация**: В папке `/docs`
- 📞 **Техническая поддержка**: Создайте Issue с меткой `support`

### Changelog:
Все изменения документируются в файле [CHANGELOG.md](CHANGELOG.md) с указанием версий и дат.

---

**Создано с ❤️ для автоматизации клиентского сервиса полиграфических типографий**
