#!/usr/bin/env python3
"""
–£–ª—É—á—à–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ü–µ–Ω –Ω–∞ –ø—Ä–µ–º–∏–∞–ª—å–Ω—ã–µ –æ—Ç–¥–µ–ª–∫–∏
"""

import re
from typing import Dict, List, Optional


class PremiumPricingDetector:
    """–î–µ—Ç–µ–∫—Ç–æ—Ä –ø—Ä–µ–º–∏–∞–ª—å–Ω—ã—Ö –æ—Ç–¥–µ–ª–æ–∫ –≤ –∑–∞–ø—Ä–æ—Å–∞—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""

    def __init__(self):
        # –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –ø—Ä–µ–º–∏–∞–ª—å–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –∏ –æ—Ç–¥–µ–ª–æ–∫
        self.premium_keywords = {
            "materials": {
                "ukr": [
                    "—á–æ—Ä–Ω–∏–π –∫–∞—Ä—Ç–æ–Ω",
                    "—á–æ—Ä–Ω–æ–º—É –∫–∞—Ä—Ç–æ–Ω—ñ",
                    "—á–µ—Ä–Ω—ã–π –∫–∞—Ä—Ç–æ–Ω",
                    "–ø—Ä–µ–º–∏—É–º –∫–∞—Ä—Ç–æ–Ω",
                    "–¥–∏–∑–∞–π–Ω–µ—Ä—Å—å–∫–∏–π –∫–∞—Ä—Ç–æ–Ω",
                    "–º–µ—Ç–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π",
                    "–ø–µ—Ä–ª–∞–º—É—Ç—Ä–æ–≤–∏–π",
                ],
                "rus": [
                    "—á–µ—Ä–Ω—ã–π –∫–∞—Ä—Ç–æ–Ω",
                    "—á–µ—Ä–Ω–æ–º –∫–∞—Ä—Ç–æ–Ω–µ",
                    "–ø—Ä–µ–º–∏—É–º –∫–∞—Ä—Ç–æ–Ω",
                    "–¥–∏–∑–∞–π–Ω–µ—Ä—Å–∫–∏–π –∫–∞—Ä—Ç–æ–Ω",
                    "–º–µ—Ç–∞–ª–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π",
                    "–ø–µ—Ä–ª–∞–º—É—Ç—Ä–æ–≤—ã–π",
                ],
            },
            "finishes": {
                "ukr": [
                    "–∫–∞—à–∏—Ä—É–≤–∞–Ω–Ω—è",
                    "–∫–∞—à–∏—Ä–æ–≤–∞–Ω",
                    "–ª–∞–º—ñ–Ω—É–≤–∞–Ω–Ω—è",
                    "—Ñ–æ–ª—å–≥—É–≤–∞–Ω–Ω—è",
                    "—Ç–∏—Å–Ω–µ–Ω–Ω—è",
                    "–ª–∞–∫",
                    "—Å–ø–æ—Ç –ª–∞–∫",
                    "soft touch",
                ],
                "rus": [
                    "–∫–∞—à–∏—Ä–æ–≤–∞–Ω–∏–µ",
                    "–∫–∞—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ",
                    "–ª–∞–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ",
                    "—Ñ–æ–ª—å–≥–∏—Ä–æ–≤–∞–Ω–∏–µ",
                    "—Ç–∏—Å–Ω–µ–Ω–∏–µ",
                    "–ª–∞–∫",
                    "—Å–ø–æ—Ç –ª–∞–∫",
                    "—Å–æ—Ñ—Ç —Ç–∞—á",
                ],
            },
            "premium_features": {
                "ukr": ["–∑–∞–∫—Ä—É–≥–ª–µ–Ω—ñ –∫—É—Ç–∏", "–≤–∏—Ä—É–±–∫–∞", "–∫–æ–Ω–≥—Ä–µ–≤", "—à–æ–≤–∫–æ–≥—Ä–∞—Ñ—ñ—è"],
                "rus": ["–∑–∞–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–µ —É–≥–ª—ã", "–≤—ã—Ä—É–±–∫–∞", "–∫–æ–Ω–≥—Ä–µ–≤", "—à–µ–ª–∫–æ–≥—Ä–∞—Ñ–∏—è"],
            },
        }

        # –ú–Ω–æ–∂–∏—Ç–µ–ª–∏ —Ü–µ–Ω –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –ø—Ä–µ–º–∏–∞–ª—å–Ω–æ–π –æ—Ç–¥–µ–ª–∫–∏
        self.price_multipliers = {
            "black_cardboard": 1.3,  # +30%
            "lamination": 1.2,  # +20%
            "foiling": 1.8,  # +80%
            "spot_uv": 1.4,  # +40%
            "die_cutting": 1.5,  # +50%
            "soft_touch": 1.6,  # +60%
            "premium_complex": 4.5,  # –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–µ –ø—Ä–µ–º–∏–∞–ª—å–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è
            "luxury_materials": 5.0,  # –õ—é–∫—Å–æ–≤—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã
        }

        # –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Ü–µ–Ω –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –º–Ω–æ–∂–∏—Ç–µ–ª—è
        self.pricing_strategies = {
            "moderate": {"range": (1.0, 1.5), "approach": "direct_pricing"},
            "premium": {"range": (1.5, 2.5), "approach": "exclusive_segment"},
            "luxury": {"range": (2.5, float("inf")), "approach": "vip_class"},
        }

    def detect_premium_features(self, query: str, language: str = "ukr") -> Dict:
        """
        –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø—Ä–µ–º–∏–∞–ª—å–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –≤ –∑–∞–ø—Ä–æ—Å–µ

        Returns:
            Dict —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –ø—Ä–µ–º–∏–∞–ª—å–Ω—ã—Ö –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—è—Ö
        """
        query_lower = query.lower()
        detected_features = []
        estimated_multiplier = 1.0

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª—ã
        for keyword in self.premium_keywords["materials"][language]:
            if keyword.lower() in query_lower:
                # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –º–Ω–æ–∂–∏—Ç–µ–ª—è
                if "—á–æ—Ä–Ω–∏–π –∫–∞—Ä—Ç–æ–Ω" in keyword.lower() or "—á–µ—Ä–Ω—ã–π –∫–∞—Ä—Ç–æ–Ω" in keyword.lower():
                    multiplier = self.price_multipliers.get("black_cardboard", 1.3)
                elif (
                    "–ø—Ä–µ–º–∏—É–º" in keyword.lower()
                    or "–¥–∏–∑–∞–π–Ω–µ—Ä—Å—å–∫–∏–π" in keyword.lower()
                    or "–¥–∏–∑–∞–π–Ω–µ—Ä—Å–∫–∏–π" in keyword.lower()
                ):
                    multiplier = self.price_multipliers.get("premium_complex", 4.5)
                elif (
                    "–º–µ—Ç–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π" in keyword.lower()
                    or "–º–µ—Ç–∞–ª–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π" in keyword.lower()
                    or "–ø–µ—Ä–ª–∞–º—É—Ç—Ä–æ–≤–∏–π" in keyword.lower()
                    or "–ø–µ—Ä–ª–∞–º—É—Ç—Ä–æ–≤—ã–π" in keyword.lower()
                ):
                    multiplier = self.price_multipliers.get("luxury_materials", 5.0)
                else:
                    multiplier = self.price_multipliers.get("black_cardboard", 1.3)

                detected_features.append(
                    {
                        "type": "material",
                        "feature": keyword,
                        "multiplier": multiplier,
                    }
                )
                estimated_multiplier = max(estimated_multiplier, multiplier)

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–¥–µ–ª–∫–∏
        for keyword in self.premium_keywords["finishes"][language]:
            if keyword.lower() in query_lower:
                feature_type = self._map_keyword_to_feature(keyword)
                multiplier = self.price_multipliers.get(feature_type, 1.4)
                detected_features.append(
                    {"type": "finish", "feature": keyword, "multiplier": multiplier}
                )
                estimated_multiplier = max(estimated_multiplier, multiplier)

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏
        for keyword in self.premium_keywords["premium_features"][language]:
            if keyword.lower() in query_lower:
                detected_features.append({"type": "feature", "feature": keyword, "multiplier": 1.4})
                estimated_multiplier = max(estimated_multiplier, 1.4)

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ –ø—Ä–µ–º–∏–∞–ª—å–Ω—ã—Ö –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–µ–π –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è –º–Ω–æ–∂–∏—Ç–µ–ª—è
        if len(detected_features) >= 2:
            # –ï—Å–ª–∏ –µ—Å—Ç—å 2+ –ø—Ä–µ–º–∏–∞–ª—å–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏, —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –º–Ω–æ–∂–∏—Ç–µ–ª—å
            if estimated_multiplier < 2.5:
                estimated_multiplier = min(4.5, estimated_multiplier * len(detected_features) * 0.8)

        return {
            "is_premium": len(detected_features) > 0,
            "features": detected_features,
            "estimated_multiplier": estimated_multiplier,
            "confidence": self._calculate_confidence(detected_features, query_lower),
        }

    def _map_keyword_to_feature(self, keyword: str) -> str:
        """–°–æ–ø–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ —Å —Ç–∏–ø–æ–º –æ—Ç–¥–µ–ª–∫–∏"""
        keyword_lower = keyword.lower()

        if any(word in keyword_lower for word in ["–∫–∞—à–∏—Ä–æ–≤–∞–Ω", "–∫–∞—à–∏—Ä—É–≤–∞–Ω–Ω—è"]):
            return "lamination"
        elif any(word in keyword_lower for word in ["—Ñ–æ–ª—å–≥", "foil"]):
            return "foiling"
        elif any(word in keyword_lower for word in ["–ª–∞–∫", "uv"]):
            return "spot_uv"
        elif any(word in keyword_lower for word in ["soft", "—Å–æ—Ñ—Ç"]):
            return "soft_touch"
        elif any(word in keyword_lower for word in ["–≤–∏—Ä—É–±–∫–∞", "–≤—ã—Ä—É–±–∫–∞"]):
            return "die_cutting"
        else:
            return "premium_finish"

    def _calculate_confidence(self, features: List[Dict], query: str) -> float:
        """–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –ø—Ä–µ–º–∏–∞–ª—å–Ω–æ—Å—Ç–∏"""
        if not features:
            return 0.0

        base_confidence = min(0.9, len(features) * 0.3 + 0.3)

        # –ü–æ–≤—ã—à–∞–µ–º —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä—è–º—ã–µ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è —Ü–µ–Ω—ã
        if any(word in query for word in ["—Ü–µ–Ω–∞", "—Ü—ñ–Ω–∞", "—Å—Ç–æ–∏—Ç", "–∫–æ—à—Ç—É—î"]):
            base_confidence += 0.1

        return min(1.0, base_confidence)

    def _get_pricing_strategy(self, multiplier: float) -> str:
        """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Ü–µ–Ω—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–Ω–æ–∂–∏—Ç–µ–ª—è"""
        for strategy_name, strategy_data in self.pricing_strategies.items():
            min_range, max_range = strategy_data["range"]
            if min_range <= multiplier < max_range:
                return strategy_data["approach"]
        return "vip_class"  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –æ—á–µ–Ω—å –≤—ã—Å–æ–∫–∏—Ö —Ü–µ–Ω

    def generate_premium_pricing_note(self, detection_result: Dict, language: str = "ukr") -> str:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ –æ –ø—Ä–µ–º–∏–∞–ª—å–Ω–æ–º —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–∏ —Å –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø–æ–¥–∞—á–µ–π"""
        if not detection_result["is_premium"]:
            return ""

        features_list = [f["feature"] for f in detection_result["features"]]
        multiplier = detection_result["estimated_multiplier"]
        strategy = self._get_pricing_strategy(multiplier)

        if language == "ukr":
            return self._generate_ukr_pricing_note(features_list, multiplier, strategy)
        else:
            return self._generate_rus_pricing_note(features_list, multiplier, strategy)

    def _generate_ukr_pricing_note(
        self, features_list: List[str], multiplier: float, strategy: str
    ) -> str:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–∫—Ä–∞–∏–Ω—Å–∫—É—é –≤–µ—Ä—Å–∏—é –ø—Ä–∏–º–µ—á–∞–Ω–∏—è –æ —Ü–µ–Ω–∞—Ö"""
        features_text = ", ".join(features_list)

        if strategy == "direct_pricing":
            # –î–ª—è —É–º–µ—Ä–µ–Ω–Ω–æ–≥–æ –ø–æ–≤—ã—à–µ–Ω–∏—è (–¥–æ 50%) - –ø—Ä—è–º—ã–µ —Ü–µ–Ω—ã
            base_price_96 = int(158 * multiplier)
            base_price_1000 = int(920 * multiplier)

            return f"""
‚ú® –ü—Ä–µ–º—ñ–∞–ª—å–Ω—ñ –≤—ñ–∑–∏—Ç–∫–∏ –∑ –æ—Å–æ–±–ª–∏–≤–æ—Å—Ç—è–º–∏: {features_text}

üí∞ –û—Ä—ñ—î–Ω—Ç–æ–≤–Ω—ñ —Ü—ñ–Ω–∏ –∑ –≤–∞—à–∏–º–∏ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è–º–∏:
‚Ä¢ 96 —à—Ç ‚Äî –≤—ñ–¥ {base_price_96} –≥—Ä–Ω
‚Ä¢ 1000 —à—Ç ‚Äî –≤—ñ–¥ {base_price_1000} –≥—Ä–Ω

üìû –î–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É –∑–≤'—è–∂—ñ—Ç—å—Å—è –∑ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º, –æ—Å–∫—ñ–ª—å–∫–∏ —Ñ—ñ–Ω–∞–ª—å–Ω–∞ —Ü—ñ–Ω–∞ –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤.

üí° –ü–æ—Ä–∞–¥–∞ –≤—ñ–¥ –û–ª–µ–Ω–∏: –ü—Ä–µ–º—ñ–∞–ª—å–Ω—ñ –≤—ñ–∑–∏—Ç–∫–∏ —Å—Ç–≤–æ—Ä—é—é—Ç—å WOW-–µ—Ñ–µ–∫—Ç —ñ –Ω–∞–¥–æ–≤–≥–æ –∑–∞–ø–∞–º'—è—Ç–æ–≤—É—é—Ç—å—Å—è –∫–ª—ñ—î–Ω—Ç–∞–º!"""

        elif strategy == "exclusive_segment":
            # –î–ª—è –ø—Ä–µ–º–∏–∞–ª—å–Ω—ã—Ö —Ü–µ–Ω (50-150%) - –∞–∫—Ü–µ–Ω—Ç –Ω–∞ —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω–æ—Å—Ç—å
            return f"""
üéñÔ∏è –ï–∫—Å–∫–ª—é–∑–∏–≤–Ω—ñ –≤—ñ–∑–∏—Ç–∫–∏ –ø—Ä–µ–º—ñ—É–º-—Å–µ–≥–º–µ–Ω—Ç—É –∑ –æ—Å–æ–±–ª–∏–≤–æ—Å—Ç—è–º–∏: {features_text}

üíé –¶—ñ–Ω–æ—É—Ç–≤–æ—Ä–µ–Ω–Ω—è –¥–ª—è –ø—Ä–µ–º—ñ—É–º-—Å–µ–≥–º–µ–Ω—Ç—É:
‚Ä¢ –¶–µ –ø—Ä–æ–¥—É–∫—Ü—ñ—è –≤–∏—â–æ—ó —Ü—ñ–Ω–æ–≤–æ—ó –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó
‚Ä¢ –¶—ñ–Ω–∞ —Ñ–æ—Ä–º—É—î—Ç—å—Å—è —ñ–Ω–¥–∏–≤—ñ–¥—É–∞–ª—å–Ω–æ –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Å–∫–ª–∞–¥–Ω–æ—Å—Ç—ñ
‚Ä¢ –û—Ä—ñ—î–Ω—Ç–∏—Ä: —É 2-3 —Ä–∞–∑–∏ –≤–∏—â–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏—Ö –≤—ñ–∑–∏—Ç–æ–∫

üìû –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—è –∑ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º –¥–æ–ø–æ–º–æ–∂–µ –ø—ñ–¥—ñ–±—Ä–∞—Ç–∏ –æ–ø—Ç–∏–º–∞–ª—å–Ω–µ —Ä—ñ—à–µ–Ω–Ω—è –¥–ª—è –≤–∞—à–æ–≥–æ –±—é–¥–∂–µ—Ç—É.

üåü –ß–æ–º—É —Ü–µ –≤–∞—Ä—Ç–æ —ñ–Ω–≤–µ—Å—Ç–∏—Ü—ñ–π: –ü—Ä–µ–º—ñ–∞–ª—å–Ω—ñ –≤—ñ–∑–∏—Ç–∫–∏ ‚Äî —Ü–µ –Ω–µ –ø—Ä–æ—Å—Ç–æ –∫–æ–Ω—Ç–∞–∫—Ç, –∞ –ø–µ—Ä—à–µ –≤—Ä–∞–∂–µ–Ω–Ω—è, —è–∫–µ —Ñ–æ—Ä–º—É—î —Å—Ç–∞—Ç—É—Å —ñ –¥–æ–≤—ñ—Ä—É –¥–æ –≤–∞—à–æ–≥–æ –±—Ä–µ–Ω–¥—É."""

        else:  # vip_class
            # –î–ª—è –æ—á–µ–Ω—å –≤—ã—Å–æ–∫–∏—Ö —Ü–µ–Ω (150%+) - VIP-–∫–ª–∞—Å—Å –∏ —Ü–µ–Ω–Ω–æ—Å—Ç—å
            per_piece_price = int((158 * multiplier) / 96)

            return f"""
üëë VIP-–∫–ª–∞—Å –≤—ñ–∑–∏—Ç–æ–∫ –∑ –µ–∫—Å–∫–ª—é–∑–∏–≤–Ω–∏–º–∏ –æ—Å–æ–±–ª–∏–≤–æ—Å—Ç—è–º–∏: {features_text}

üíé –Ü–Ω–¥–∏–≤—ñ–¥—É–∞–ª—å–Ω–µ —Ü—ñ–Ω–æ—É—Ç–≤–æ—Ä–µ–Ω–Ω—è –¥–ª—è VIP-–ø—Ä–æ–¥—É–∫—Ü—ñ—ó:
‚Ä¢ –û—Ä—ñ—î–Ω—Ç–æ–≤–Ω–∞ –≤–∞—Ä—Ç—ñ—Å—Ç—å: –≤—ñ–¥ {per_piece_price} –≥—Ä–Ω –∑–∞ –≤—ñ–∑–∏—Ç–∫—É
‚Ä¢ –¶–µ –∞–≤—Ç–æ—Ä—Å—å–∫–∞ —Ä–æ–±–æ—Ç–∞ –∑ —É–Ω—ñ–∫–∞–ª—å–Ω–∏–º–∏ –º–∞—Ç–µ—Ä—ñ–∞–ª–∞–º–∏
‚Ä¢ –¢–µ—Ä–º—ñ–Ω –≤–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—è: 7-10 —Ä–æ–±–æ—á–∏—Ö –¥–Ω—ñ–≤

üéØ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∏–π –º–µ–Ω–µ–¥–∂–µ—Ä —Ä–æ–∑—Ä–∞—Ö—É—î –æ–ø—Ç–∏–º–∞–ª—å–Ω–µ —Ä—ñ—à–µ–Ω–Ω—è –ø—ñ–¥ –≤–∞—à –ø—Ä–æ—î–∫—Ç —ñ –±—é–¥–∂–µ—Ç.

üöÄ –ï—Ñ–µ–∫—Ç –≤—ñ–¥ —ñ–Ω–≤–µ—Å—Ç–∏—Ü—ñ–π: VIP-–≤—ñ–∑–∏—Ç–∫–∏ –ø–µ—Ä–µ—Ç–≤–æ—Ä—é—é—Ç—å –∑–≤–∏—á–∞–π–Ω–µ –∑–Ω–∞–π–æ–º—Å—Ç–≤–æ –≤ –∑–∞–ø–∞–º'—è—Ç–æ–≤—É—é—á–∏–π –¥–æ—Å–≤—ñ–¥, –ø—ñ–¥–≤–∏—â—É—é—Ç—å —Å–ø—Ä–∏–π–Ω—è—Ç—Ç—è —Å—Ç–∞—Ç—É—Å—É —Ç–∞ –ø—Ä–æ—Ñ–µ—Å—ñ–æ–Ω–∞–ª—ñ–∑–º—É —É —Ä–∞–∑–∏."""

    def _generate_rus_pricing_note(
        self, features_list: List[str], multiplier: float, strategy: str
    ) -> str:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ä—É—Å—Å–∫—É—é –≤–µ—Ä—Å–∏—é –ø—Ä–∏–º–µ—á–∞–Ω–∏—è –æ —Ü–µ–Ω–∞—Ö"""
        features_text = ", ".join(features_list)

        if strategy == "direct_pricing":
            # –î–ª—è —É–º–µ—Ä–µ–Ω–Ω–æ–≥–æ –ø–æ–≤—ã—à–µ–Ω–∏—è (–¥–æ 50%) - –ø—Ä—è–º—ã–µ —Ü–µ–Ω—ã
            base_price_96 = int(158 * multiplier)
            base_price_1000 = int(920 * multiplier)

            return f"""
‚ú® –ü—Ä–µ–º–∏–∞–ª—å–Ω—ã–µ –≤–∏–∑–∏—Ç–∫–∏ —Å –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—è–º–∏: {features_text}

üí∞ –û—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω—ã–µ —Ü–µ–Ω—ã —Å –≤–∞—à–∏–º–∏ —É–ª—É—á—à–µ–Ω–∏—è–º–∏:
‚Ä¢ 96 —à—Ç ‚Äî –æ—Ç {base_price_96} –≥—Ä–Ω
‚Ä¢ 1000 —à—Ç ‚Äî –æ—Ç {base_price_1000} –≥—Ä–Ω

üìû –î–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º, –ø–æ—Å–∫–æ–ª—å–∫—É —Ñ–∏–Ω–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤.

üí° –°–æ–≤–µ—Ç –æ—Ç –û–ª–µ–Ω—ã: –ü—Ä–µ–º–∏–∞–ª—å–Ω—ã–µ –≤–∏–∑–∏—Ç–∫–∏ —Å–æ–∑–¥–∞—é—Ç WOW-—ç—Ñ—Ñ–µ–∫—Ç –∏ –Ω–∞–¥–æ–ª–≥–æ –∑–∞–ø–æ–º–∏–Ω–∞—é—Ç—Å—è –∫–ª–∏–µ–Ω—Ç–∞–º!"""

        elif strategy == "exclusive_segment":
            # –î–ª—è –ø—Ä–µ–º–∏–∞–ª—å–Ω—ã—Ö —Ü–µ–Ω (50-150%) - –∞–∫—Ü–µ–Ω—Ç –Ω–∞ —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω–æ—Å—Ç—å
            return f"""
üéñÔ∏è –≠–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–µ –≤–∏–∑–∏—Ç–∫–∏ –ø—Ä–µ–º–∏—É–º-—Å–µ–≥–º–µ–Ω—Ç–∞ —Å –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—è–º–∏: {features_text}

üíé –¶–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –¥–ª—è –ø—Ä–µ–º–∏—É–º-—Å–µ–≥–º–µ–Ω—Ç–∞:
‚Ä¢ –≠—Ç–æ –ø—Ä–æ–¥—É–∫—Ü–∏—è –≤—ã—Å—à–µ–π —Ü–µ–Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
‚Ä¢ –¶–µ–Ω–∞ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
‚Ä¢ –û—Ä–∏–µ–Ω—Ç–∏—Ä: –≤ 2-3 —Ä–∞–∑–∞ –≤—ã—à–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –≤–∏–∑–∏—Ç–æ–∫

üìû –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º –ø–æ–º–æ–∂–µ—Ç –ø–æ–¥–æ–±—Ä–∞—Ç—å –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –≤–∞—à–µ–≥–æ –±—é–¥–∂–µ—Ç–∞.

üåü –ü–æ—á–µ–º—É —ç—Ç–æ —Å—Ç–æ–∏—Ç –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π: –ü—Ä–µ–º–∏–∞–ª—å–Ω—ã–µ –≤–∏–∑–∏—Ç–∫–∏ ‚Äî —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ –∫–æ–Ω—Ç–∞–∫—Ç, –∞ –ø–µ—Ä–≤–æ–µ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç —Å—Ç–∞—Ç—É—Å –∏ –¥–æ–≤–µ—Ä–∏–µ –∫ –≤–∞—à–µ–º—É –±—Ä–µ–Ω–¥—É."""

        else:  # vip_class
            # –î–ª—è –æ—á–µ–Ω—å –≤—ã—Å–æ–∫–∏—Ö —Ü–µ–Ω (150%+) - VIP-–∫–ª–∞—Å—Å –∏ —Ü–µ–Ω–Ω–æ—Å—Ç—å
            per_piece_price = int((158 * multiplier) / 96)

            return f"""
üëë VIP-–∫–ª–∞—Å—Å –≤–∏–∑–∏—Ç–æ–∫ —Å —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–º–∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—è–º–∏: {features_text}

üíé –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–µ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –¥–ª—è VIP-–ø—Ä–æ–¥—É–∫—Ü–∏–∏:
‚Ä¢ –û—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: –æ—Ç {per_piece_price} –≥—Ä–Ω –∑–∞ –≤–∏–∑–∏—Ç–∫—É
‚Ä¢ –≠—Ç–æ –∞–≤—Ç–æ—Ä—Å–∫–∞—è —Ä–∞–±–æ—Ç–∞ —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º–∏
‚Ä¢ –°—Ä–æ–∫ –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è: 7-10 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π

üéØ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä —Ä–∞—Å—Å—á–∏—Ç–∞–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –ø–æ–¥ –≤–∞—à –ø—Ä–æ–µ–∫—Ç –∏ –±—é–¥–∂–µ—Ç.

üöÄ –≠—Ñ—Ñ–µ–∫—Ç –æ—Ç –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π: VIP-–≤–∏–∑–∏—Ç–∫–∏ –ø—Ä–µ–≤—Ä–∞—â–∞—é—Ç –æ–±—ã—á–Ω–æ–µ –∑–Ω–∞–∫–æ–º—Å—Ç–≤–æ –≤ –∑–∞–ø–æ–º–∏–Ω–∞—é—â–∏–π—Å—è –æ–ø—ã—Ç, –ø–æ–≤—ã—à–∞—é—Ç –≤–æ—Å–ø—Ä–∏—è—Ç–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–∏–∑–º–∞ –≤ —Ä–∞–∑—ã."""


def enhance_ai_response_with_premium_pricing(
    original_response: str, user_query: str, language: str = "ukr"
) -> str:
    """
    –£–ª—É—á—à–∞–µ—Ç –æ—Ç–≤–µ—Ç AI —Å —É—á–µ—Ç–æ–º –ø—Ä–µ–º–∏–∞–ª—å–Ω–æ–≥–æ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è

    Args:
        original_response: –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç AI
        user_query: –ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        language: –Ø–∑—ã–∫ –æ—Ç–≤–µ—Ç–∞

    Returns:
        –£–ª—É—á—à–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ü–µ–Ω–∞—Ö
    """
    detector = PremiumPricingDetector()
    detection = detector.detect_premium_features(user_query, language)

    if not detection["is_premium"]:
        return original_response

    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ –æ –ø—Ä–µ–º–∏–∞–ª—å–Ω–æ–º —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–∏
    premium_note = detector.generate_premium_pricing_note(detection, language)

    # –ï—Å–ª–∏ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º –æ—Ç–≤–µ—Ç–µ –µ—Å—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ü–µ–Ω—ã, –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
    if any(price in original_response for price in ["158 –≥—Ä–Ω", "920 –≥—Ä–Ω"]):
        if language == "ukr":
            warning = "\n\n‚ö†Ô∏è –£–≤–∞–≥–∞: –í–∫–∞–∑–∞–Ω—ñ —Ü—ñ–Ω–∏ –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏—Ö –≤—ñ–∑–∏—Ç–æ–∫. –î–ª—è –ø—Ä–µ–º—ñ–∞–ª—å–Ω–∏—Ö –º–∞—Ç–µ—Ä—ñ–∞–ª—ñ–≤ —Ü—ñ–Ω–∏ –±—É–¥—É—Ç—å –≤–∏—â–∏–º–∏."
        else:
            warning = "\n\n‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: –£–∫–∞–∑–∞–Ω–Ω—ã–µ —Ü–µ–Ω—ã –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –≤–∏–∑–∏—Ç–æ–∫. –î–ª—è –ø—Ä–µ–º–∏–∞–ª—å–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ —Ü–µ–Ω—ã –±—É–¥—É—Ç –≤—ã—à–µ."

        # –í—Å—Ç–∞–≤–ª—è–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –∫–æ–Ω—Ç–∞–∫—Ç–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
        if (
            "–∑–≤'—è–∂—ñ—Ç—å—Å—è –∑ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º" in original_response
            or "—Å–≤—è–∂–∏—Ç–µ—Å—å —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º" in original_response
        ):
            parts = original_response.split(
                "–∑–≤'—è–∂—ñ—Ç—å—Å—è –∑ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º" if language == "ukr" else "—Å–≤—è–∂–∏—Ç–µ—Å—å —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º"
            )
            enhanced_response = (
                parts[0]
                + warning
                + premium_note
                + "\n\n–ó–≤'—è–∂—ñ—Ç—å—Å—è –∑ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º"
                + "".join(parts[1:])
                if language == "ukr"
                else parts[0]
                + warning
                + premium_note
                + "\n\n–°–≤—è–∂–∏—Ç–µ—Å—å —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º"
                + "".join(parts[1:])
            )
        else:
            enhanced_response = original_response + warning + premium_note
    else:
        enhanced_response = original_response + premium_note

    return enhanced_response


# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –≤ Enhanced AI Service
def integrate_premium_pricing_detection():
    """
    –ü—Ä–∏–º–µ—Ä –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –≤ Enhanced AI Service
    """

    example_usage = """
    # –í enhanced_ai_service.py –≤ –º–µ—Ç–æ–¥–µ _process_with_enhanced_openai –∏–ª–∏ _process_with_enhanced_mock

    # –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç OpenAI:
    original_answer = response.choices[0].message.content.strip()

    # –£–ª—É—á—à–∞–µ–º –æ—Ç–≤–µ—Ç —Å —É—á–µ—Ç–æ–º –ø—Ä–µ–º–∏–∞–ª—å–Ω–æ–≥–æ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è
    enhanced_answer = enhance_ai_response_with_premium_pricing(
        original_answer,
        user_query,
        language
    )

    return {
        "answer": enhanced_answer,
        "confidence": confidence,
        "source": "enhanced_openai_with_premium_pricing"
    }
    """

    return example_usage


if __name__ == "__main__":
    # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
    detector = PremiumPricingDetector()

    test_queries = [
        "–°–∫—ñ–ª—å–∫–∏ –∫–æ—à—Ç—É—é—Ç—å –≤—ñ–∑–∏—Ç–∫–∏ –Ω–∞ —á–æ—Ä–Ω–æ–º—É –∫–∞—Ä—Ç–æ–Ω—ñ?",
        "–•–æ—á—É –≤—ñ–∑–∏—Ç–∫–∏ –∑ –∫–∞—à–∏—Ä—É–≤–∞–Ω–Ω—è–º",
        "–ú–æ–∂–Ω–∞ –∑—Ä–æ–±–∏—Ç–∏ –≤—ñ–∑–∏—Ç–∫–∏ –∑ —Ñ–æ–ª—å–≥—É–≤–∞–Ω–Ω—è–º?",
        "–ó–≤–∏—á–∞–π–Ω—ñ –≤—ñ–∑–∏—Ç–∫–∏, —Å–∫—ñ–ª—å–∫–∏ –∫–æ—à—Ç—É—é—Ç—å?",
        "–í—ñ–∑–∏—Ç–∫–∏ –∑ soft touch –ø–æ–∫—Ä–∏—Ç—Ç—è–º",
    ]

    for query in test_queries:
        print(f"\nüîç –ó–∞–ø—Ä–æ—Å: {query}")
        result = detector.detect_premium_features(query, "ukr")
        print(f"   –ü—Ä–µ–º–∏–∞–ª—å–Ω—ã–π: {result['is_premium']}")
        print(f"   –ú–Ω–æ–∂–∏—Ç–µ–ª—å: {result['estimated_multiplier']:.1f}x")
        print(f"   –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏: {[f['feature'] for f in result['features']]}")
